{% extends 'base.html' %}
{% block content %}
  <div class="container">
    <div class="journey-header glass-card">
      <div>
        <p class="section-kicker">Live delivery</p>
        <h2 class="mb-1">Journey in Progress</h2>
        <p class="text-muted">Track route, payment, and delivery status in real time.</p>
      </div>
      <a href="{{ url_for('driver.driver_dashboard') }}" class="btn btn-outline-light">Back to Dashboard</a>
    </div>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="glass-card p-4">
          <h5 class="mb-3">Delivery Details</h5>
          <div class="mb-2"><strong>From:</strong> {{ booking.origin }}</div>
          <div class="mb-2"><strong>To:</strong> {{ booking.destination }}</div>
          <div class="mb-2"><strong>Customer:</strong> {{ booking.user.full_name or booking.user.username }}</div>
          <div class="mb-2"><strong>Phone:</strong> {{ booking.user.phone or 'Not provided' }}</div>
          <div class="mb-2"><strong>Price:</strong> {{ booking.price }} NPR</div>
          <div class="mb-2"><strong>Payment:</strong> {{ booking.payment_method|replace('_', ' ')|title }} by {{ booking.payment_by|title }}</div>
          <div class="mb-2"><strong>Payment Status:</strong>
            {% if booking.payment_method in ['cash', 'on_delivery'] %}
              {{ 'Received' if booking.payment_received else 'Pending' }}
            {% else %}
              Paid (Online)
            {% endif %}
          </div>
          
          <div class="mt-3 p-3 journey-status-card">
            <div class="mb-2"><strong>Status:</strong> <span id="journey-status">Waiting to start</span></div>
            <div class="progress mb-2" style="height: 25px;">
              <div class="progress-bar bg-success" role="progressbar" id="journey-progress" style="width: 0%">0%</div>
            </div>
            <div class="text-muted small" id="journey-eta">Calculating route...</div>
          </div>

          <div class="mt-3 d-flex gap-2">
            {% if booking.status in ['arrived', 'accepted'] %}
              <form method="POST" action="{{ url_for('driver.start_journey', booking_id=booking.id) }}" style="display:inline;">
                {% if booking.payment_method in ['on_delivery', 'cash'] and booking.payment_by == 'sender' %}
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="payment_received" id="pickup_payment_received">
                    <label class="form-check-label" for="pickup_payment_received">Payment received from sender</label>
                  </div>
                {% endif %}
                <button class="btn btn-success mt-2" id="start-journey-btn" {% if booking.payment_method in ['on_delivery', 'cash'] and booking.payment_by == 'sender' %}disabled{% endif %}>Start Journey</button>
              </form>
            {% elif booking.status == 'in_transit' %}
              <form method="POST" action="{{ url_for('driver.mark_delivered', booking_id=booking.id) }}" style="display:inline;">
                {% if booking.payment_method in ['on_delivery', 'cash'] and booking.payment_by == 'receiver' %}
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="payment_received" id="payment_received">
                    <label class="form-check-label" for="payment_received">Payment received from receiver</label>
                  </div>
                {% endif %}
                <button class="btn btn-primary mt-2" id="mark-delivered-btn" disabled>Mark as Delivered</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="glass-card p-3">
          <div id="journey-map" class="journey-map"></div>
        </div>
      </div>
    </div>
  </div>

{% block extra_js %}
  <script>
    (function(){
      const originLat = {{ booking.origin_lat }};
      const originLng = {{ booking.origin_lng }};
      const destLat = {{ booking.dest_lat }};
      const destLng = {{ booking.dest_lng }};

      const status = "{{ booking.status }}";
      const map = L.map('journey-map').setView([originLat, originLng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      // Add markers for origin and destination
      const originMarker = L.marker([originLat, originLng]).addTo(map)
        .bindPopup('<b>Pickup Location</b><br>' + '{{ booking.origin }}');
      
      const destMarker = L.marker([destLat, destLng]).addTo(map)
        .bindPopup('<b>Delivery Location</b><br>' + '{{ booking.destination }}');

      // Driver marker (moving)
      const driverIcon = L.divIcon({
        html: '<div style="background: #FF9F43; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
        iconSize: [20, 20],
        className: ''
      });
      const driverMarker = L.marker([originLat, originLng], { icon: driverIcon }).addTo(map);

      // Get route from OSRM
      let routeCoordinates = [];
      let currentStep = 0;
      let animationInterval = null;

      fetch(`https://router.project-osrm.org/route/v1/driving/${originLng},${originLat};${destLng},${destLat}?overview=full&geometries=geojson`)
        .then(r => r.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            routeCoordinates = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lat, lng]
            
            // Draw route on map
            L.polyline(routeCoordinates, {
              color: '#FF9F43',
              weight: 5,
              opacity: 0.7
            }).addTo(map);

            // Fit map to show entire route
            map.fitBounds([
              [originLat, originLng],
              [destLat, destLng]
            ]);

            const totalSteps = routeCoordinates.length;
            const stepDuration = 30000 / totalSteps; // Complete journey in 30 seconds

            document.getElementById('journey-eta').textContent = `Total distance: ${(route.distance / 1000).toFixed(2)} km | Duration: ~${Math.round(route.duration / 60)} mins`;

            if (status === 'in_transit') {
              document.getElementById('journey-status').textContent = 'En Route';
              animationInterval = setInterval(() => {
                if (currentStep < routeCoordinates.length) {
                  const coord = routeCoordinates[currentStep];
                  driverMarker.setLatLng(coord);
                  
                  // Update progress
                  const progress = Math.round((currentStep / totalSteps) * 100);
                  document.getElementById('journey-progress').style.width = progress + '%';
                  document.getElementById('journey-progress').textContent = progress + '%';
                  
                  currentStep++;
                } else {
                  // Journey complete
                  clearInterval(animationInterval);
                  document.getElementById('journey-status').textContent = 'Arrived at Destination';
                  document.getElementById('journey-progress').style.width = '100%';
                  document.getElementById('journey-progress').textContent = '100%';
                  const paymentCheck = document.getElementById('payment_received');
                  if (!paymentCheck || paymentCheck.checked) {
                    document.getElementById('mark-delivered-btn').disabled = false;
                  }
                  document.getElementById('mark-delivered-btn').classList.add('btn-pulse');
                  
                  // Show notification
                  alert('You have arrived at the destination! You can now mark the delivery as complete.');
                }
              }, stepDuration);
            } else {
              document.getElementById('journey-status').textContent = 'Waiting to start';
            }
          } else {
            document.getElementById('journey-status').textContent = 'Route not found';
            alert('Could not calculate route. Please check coordinates.');
          }
        })
        .catch(err => {
          console.error('Route error:', err);
          document.getElementById('journey-status').textContent = 'Error loading route';
        });

    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const pickupPaymentCheck = document.getElementById('pickup_payment_received');
      const startJourneyBtn = document.getElementById('start-journey-btn');
      if (pickupPaymentCheck && startJourneyBtn) {
        pickupPaymentCheck.addEventListener('change', function () {
          startJourneyBtn.disabled = !pickupPaymentCheck.checked;
        });
      }

      const paymentCheck = document.getElementById('payment_received');
      const deliveredBtn = document.getElementById('mark-delivered-btn');
      if (!paymentCheck || !deliveredBtn) return;
      paymentCheck.addEventListener('change', function () {
        deliveredBtn.disabled = !paymentCheck.checked;
      });
    });
  </script>
  <style>
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .btn-pulse {
      animation: pulse 1.5s infinite;
    }
    .journey-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .journey-map {
      height: 600px;
      border-radius: 16px;
      overflow: hidden;
    }
    .journey-status-card {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
  </style>
{% endblock %}
{% endblock %}
