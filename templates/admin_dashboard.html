{% extends 'base.html' %}
{% block content %}
<style>
.admin-header {
  background: var(--gradient-hero);
  color: white;
  padding: 32px;
  border-radius: 20px;
  margin-bottom: 32px;
  box-shadow: var(--shadow-xl);
}

.admin-header h1 {
  margin: 0;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

.admin-tabs {
  margin-bottom: 32px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.admin-tabs button {
  padding: 14px 28px;
  border: 1px solid var(--glass-border);
  background: rgba(15, 23, 42, 0.6);
  cursor: pointer;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  color: var(--text-primary);
  font-size: 1rem;
}

.admin-tabs button.active {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-md), var(--shadow-glow);
  transform: translateY(-2px);
}

.admin-tabs button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.user-section {
  display: none;
}

.user-section.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.user-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-left: 4px solid var(--primary);
  padding: 28px;
  margin-bottom: 24px;
  border-radius: 16px;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.user-card:hover {
  box-shadow: var(--shadow-xl);
  transform: translateX(4px);
}

.user-card h5 {
  color: var(--primary);
  margin-bottom: 20px;
  font-weight: 700;
  font-size: 1.25rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
  padding: 20px;
  background: rgba(15, 23, 42, 0.55);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
}

.info-item {
  font-size: 0.95rem;
}

.info-label {
  font-weight: 700;
  color: #e2e8f0;
  display: block;
  margin-bottom: 4px;
}

.info-value {
  color: #cbd5f5;
}

.status-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.status-pending { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #78350f; }
.status-accepted { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e3a8a; }
.status-in_transit { background: linear-gradient(135deg, #a5f3fc, #67e8f9); color: #164e63; }
.status-delivered { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
.status-cancelled { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; }

.booking-item {
  background: rgba(15, 23, 42, 0.55);
  padding: 20px;
  margin: 12px 0;
  border-radius: 12px;
  border-left: 3px solid var(--primary);
  border: 1px solid var(--glass-border);
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

.booking-item:hover {
  transform: translateX(4px);
  box-shadow: var(--shadow-md);
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.booking-route {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.05rem;
}

.booking-details {
  font-size: 0.9rem;
  color: #cbd5f5;
  margin: 8px 0;
}

.payment-info {
  background: rgba(30, 41, 59, 0.6);
  padding: 14px;
  border-radius: 10px;
  margin: 12px 0;
  font-size: 0.9rem;
  border-left: 3px solid var(--info);
  color: #e2e8f0;
}

.payment-upfront { 
  background: rgba(34, 197, 94, 0.18);
  border-left-color: var(--success);
}

.payment-on_delivery { 
  background: rgba(245, 158, 11, 0.18);
  border-left-color: var(--warning);
}

.rating-panel {
  background: rgba(59, 130, 246, 0.12);
  border: 1px solid rgba(59, 130, 246, 0.25);
  padding: 10px;
  border-radius: 8px;
}

.admin-modal-header {
  background: var(--gradient-primary);
  color: white;
}

.admin-modal-header-success {
  background: var(--gradient-success);
  color: white;
}

.admin-dashboard .modal-content {
  background: #0f172a !important;
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
}

.admin-dashboard .modal-body,
.admin-dashboard .modal-footer {
  color: var(--text-primary);
}

.admin-dashboard .table {
  background: rgba(15, 23, 42, 0.65);
  color: var(--text-primary);
  border: 1px solid var(--glass-border);
}

.admin-dashboard .table th,
.admin-dashboard .table td {
  color: var(--text-primary);
  border-color: rgba(148, 163, 184, 0.2);
}

.admin-dashboard .table tbody tr:hover {
  background: rgba(37, 99, 235, 0.12);
}

.status-row {
  border-left: 4px solid transparent;
}

.status-row.status-pending { border-left-color: #f59e0b; }
.status-row.status-accepted { border-left-color: #3b82f6; }
.status-row.status-in_transit { border-left-color: #06b6d4; }
.status-row.status-delivered { border-left-color: #22c55e; }
.status-row.status-cancelled { border-left-color: #ef4444; }

.role-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.3px;
  color: white;
}

.role-admin { background: #ef4444; }
.role-driver { background: #3b82f6; }
.role-user { background: #22c55e; }

.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.analysis-card {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 18px;
  box-shadow: var(--shadow-sm);
}

.analysis-card h6 {
  color: #e2e8f0;
  font-weight: 700;
  margin-bottom: 6px;
}

.analysis-value {
  font-size: 1.4rem;
  font-weight: 800;
  color: #f8fafc;
}

.analysis-subtext {
  font-size: 0.85rem;
  color: #cbd5f5;
}

.analysis-panel {
  background: rgba(15, 23, 42, 0.55);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.analysis-bar {
  height: 10px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.2);
  overflow: hidden;
}

.analysis-bar span {
  display: block;
  height: 100%;
  background: var(--gradient-primary);
}
</style>

<div class="container-fluid mt-4 admin-dashboard">
  <div class="admin-header">
    <h1>‚ö° Admin Control Center</h1>
    <p class="mb-0" style="opacity: 0.95;">Manage users, drivers, and bookings from one powerful dashboard</p>
  </div>

  <!-- Tab Buttons -->
  <div class="admin-tabs">
    <button class="tab-btn active" onclick="switchTab('customers')">üë• Customers</button>
    <button class="tab-btn" onclick="switchTab('drivers')">üöó Drivers</button>
    <button class="tab-btn" onclick="switchTab('all-bookings')">üì¶ All Bookings</button>
    <button class="tab-btn" onclick="switchTab('pricing')">üìà Pricing Analysis</button>
    <button class="tab-btn" onclick="switchTab('manage')">‚öôÔ∏è Manage Users</button>
  </div>

  <!-- CUSTOMERS TAB -->
  <div id="customers" class="user-section active">
    <h3>Customer List & Activity</h3>
    {% set customers = users | selectattr('role', 'equalto', 'user') | list %}
    {% if customers %}
      {% for user in customers %}
        <div class="user-card">
          <h5>üë§ {{ user.username }}</h5>
          <div class="user-info">
            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value">{{ user.email }}</span></div>
            <div class="info-item"><span class="info-label">Phone:</span> <span class="info-value">{{ user.phone or 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">Age:</span> <span class="info-value">{{ user.age or 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">Total Bookings:</span> <span class="info-value">{{ user.bookings | length }}</span></div>
            <div class="info-item">
              <span class="info-label">Rating:</span> 
              <span class="info-value">
                {% set avg_rating = user.get_average_rating() %}
                {% if avg_rating > 0 %}
                  <span class="badge bg-warning text-dark">{{ "%.1f"|format(avg_rating) }}‚≠ê</span>
                  <small>({{ user.get_total_ratings() }} reviews)</small>
                {% else %}
                  <span class="text-muted">No ratings yet</span>
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Booking Summary -->
          {% if user.bookings %}
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#bookingsModal{{ user.id }}">
              üìã View Bookings ({{ user.bookings | length }})
            </button>
          {% else %}
            <p style="color: #999; margin-top: 10px;">No bookings yet.</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p style="text-align: center; color: #999; margin-top: 20px;">No customers found.</p>
    {% endif %}

    <!-- Customer Booking Modals -->
    {% for user in customers %}
      {% if user.bookings %}
        <div class="modal fade" id="bookingsModal{{ user.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header admin-modal-header">
                <h5 class="modal-title">üìã Booking Activity: {{ user.username }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                {% for booking in user.bookings | reverse %}
                  <div class="booking-item mb-3">
                    <div class="booking-header">
                      <div class="booking-route">{{ booking.origin }} ‚Üí {{ booking.destination }}</div>
                      <span class="status-badge status-{{ booking.status }}">{{ booking.status | upper }}</span>
                    </div>
                    <div class="booking-details">
                      <strong>Price:</strong> ‚Çπ{{ booking.price }} | <strong>Distance:</strong> {{ booking.distance_km or 'N/A' }}km | <strong>Date:</strong> {{ booking.date }}
                    </div>
                    <div class="payment-info {% if booking.payment_method == 'upfront' %}payment-upfront{% else %}payment-on_delivery{% endif %}">
                      <strong>Payment:</strong> {{ booking.payment_method | upper }} by {{ booking.payment_by | upper }}
                    </div>
                    {% if booking.driver %}
                      <div class="booking-details">
                        <strong>Driver:</strong> {{ booking.driver.username }} ({{ booking.driver.phone }})
                      </div>
                    {% endif %}
                    {% if booking.status == 'delivered' %}
                      <div class="booking-details mt-2 rating-panel">
                        {% if booking.driver_rating %}
                          <div><strong>Customer‚ÜíDriver:</strong> {{ booking.driver_rating }}‚≠ê {% if booking.driver_feedback %}<em>"{{ booking.driver_feedback }}"</em>{% endif %}</div>
                        {% endif %}
                        {% if booking.user_rating %}
                          <div><strong>Driver‚ÜíCustomer:</strong> {{ booking.user_rating }}‚≠ê {% if booking.user_feedback %}<em>"{{ booking.user_feedback }}"</em>{% endif %}</div>
                        {% endif %}
                        {% if not booking.driver_rating and not booking.user_rating %}
                          <div class="text-muted"><small>No ratings yet</small></div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- DRIVERS TAB -->
  <div id="drivers" class="user-section">
    <h3>Driver List & Activity</h3>
    {% set applicants = (users | selectattr('driver_status', 'equalto', 'pending') | list) + (users | selectattr('driver_status', 'equalto', 'rejected') | list) %}
    {% if applicants %}
      <div class="mb-3">
        <h5>Pending / Reviewed Applications</h5>
        {% for user in applicants %}
          <div class="user-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5>üö¶ {{ user.username }} ‚Äî status: {{ user.driver_status|upper }}</h5>
              {% if user.driver_status == 'pending' %}
                <span class="status-badge status-pending">PENDING</span>
              {% elif user.driver_status == 'rejected' %}
                <span class="status-badge status-cancelled">REJECTED</span>
              {% endif %}
            </div>
            <div class="user-info">
              <div class="info-item"><span class="info-label">Email:</span> <span class="info-value">{{ user.email }}</span></div>
              <div class="info-item"><span class="info-label">Phone:</span> <span class="info-value">{{ user.phone or 'N/A' }}</span></div>
              <div class="info-item"><span class="info-label">Vehicle:</span> <span class="info-value">{{ user.vehicle_brand or '‚Äî' }} {{ user.vehicle_name or '' }}</span></div>
              <div class="info-item"><span class="info-label">Plate:</span> <span class="info-value">{{ user.vehicle_plate or '‚Äî' }}</span></div>
            </div>
            <div class="mt-2">
              {% if user.driver_license_path %}<a href="{{ user.driver_license_path }}" target="_blank">License</a>{% endif %}
              {% if user.driver_bluebook_path %} ‚Ä¢ <a href="{{ user.driver_bluebook_path }}" target="_blank">Blue Book</a>{% endif %}
              {% if user.driver_photo_path %} ‚Ä¢ <a href="{{ user.driver_photo_path }}" target="_blank">Driver Photo</a>{% endif %}
            </div>
            {% if user.driver_feedback and user.driver_status == 'rejected' %}
              <div class="mt-2 text-muted"><strong>Feedback:</strong> {{ user.driver_feedback }}</div>
            {% endif %}
            <div class="d-flex gap-2 mt-3">
              <form method="POST" action="{{ url_for('admin.admin_driver_approve', user_id=user.id) }}">
                <input type="hidden" name="feedback" value="">
                <button class="btn btn-success btn-sm" type="submit">Approve as Driver</button>
              </form>
              <form method="POST" action="{{ url_for('admin.admin_driver_reject', user_id=user.id) }}" class="d-flex gap-2 align-items-center">
                <input type="text" name="feedback" class="form-control form-control-sm" placeholder="Feedback (optional)" style="max-width:200px;">
                <button class="btn btn-outline-danger btn-sm" type="submit">Reject</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {% set drivers = users | selectattr('role', 'equalto', 'driver') | list %}
    {% if drivers %}
      {% for user in drivers %}
        <div class="user-card">
          <h5>üöó {{ user.username }}</h5>
          <div class="user-info">
            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value">{{ user.email }}</span></div>
            <div class="info-item"><span class="info-label">Phone:</span> <span class="info-value">{{ user.phone or 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">Age:</span> <span class="info-value">{{ user.age or 'N/A' }}</span></div>
            <div class="info-item"><span class="info-label">Vehicle:</span> <span class="info-value">{{ user.vehicle_info or 'Not specified' }}</span></div>
            <div class="info-item"><span class="info-label">Available:</span> <span class="info-value">{% if user.driver_available %}‚úÖ Yes{% else %}‚ùå No{% endif %}</span></div>
            <div class="info-item"><span class="info-label">Assigned Bookings:</span> <span class="info-value">{{ user.assigned_bookings | length }}</span></div>
            <div class="info-item">
              <span class="info-label">Rating:</span> 
              <span class="info-value">
                {% set avg_rating = user.get_average_rating() %}
                {% if avg_rating > 0 %}
                  <span class="badge bg-warning text-dark">{{ "%.1f"|format(avg_rating) }}‚≠ê</span>
                  <small>({{ user.get_total_ratings() }} reviews)</small>
                {% else %}
                  <span class="text-muted">No ratings yet</span>
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Assigned Deliveries -->
          {% if user.assigned_bookings %}
            <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#deliveriesModal{{ user.id }}">
              üöö View Deliveries ({{ user.assigned_bookings | length }})
            </button>
          {% else %}
            <p style="color: #999; margin-top: 10px;">No assigned bookings yet.</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p style="text-align: center; color: #999; margin-top: 20px;">No drivers found.</p>
    {% endif %}

    <!-- Driver Delivery Modals -->
    {% for user in drivers %}
      {% if user.assigned_bookings %}
        <div class="modal fade" id="deliveriesModal{{ user.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header admin-modal-header-success">
                <h5 class="modal-title">üöö Assigned Deliveries: {{ user.username }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                {% for booking in user.assigned_bookings | reverse %}
                  <div class="booking-item mb-3">
                    <div class="booking-header">
                      <div class="booking-route">{{ booking.origin }} ‚Üí {{ booking.destination }}</div>
                      <span class="status-badge status-{{ booking.status }}">{{ booking.status | upper }}</span>
                    </div>
                    <div class="booking-details">
                      <strong>Price:</strong> ‚Çπ{{ booking.price }} | <strong>Distance:</strong> {{ booking.distance_km or 'N/A' }}km | <strong>Date:</strong> {{ booking.date }}
                    </div>
                    <div class="payment-info {% if booking.payment_method == 'upfront' %}payment-upfront{% else %}payment-on_delivery{% endif %}">
                      <strong>Payment:</strong> {{ booking.payment_method | upper }} by {{ booking.payment_by | upper }}
                    </div>
                    <div class="booking-details">
                      <strong>Customer:</strong> {{ booking.user.username }} ({{ booking.user.phone }})
                    </div>
                    {% if booking.status == 'delivered' %}
                      <div class="booking-details mt-2 rating-panel">
                        {% if booking.driver_rating %}
                          <div><strong>Customer‚ÜíDriver:</strong> {{ booking.driver_rating }}‚≠ê {% if booking.driver_feedback %}<em>"{{ booking.driver_feedback }}"</em>{% endif %}</div>
                        {% endif %}
                        {% if booking.user_rating %}
                          <div><strong>Driver‚ÜíCustomer:</strong> {{ booking.user_rating }}‚≠ê {% if booking.user_feedback %}<em>"{{ booking.user_feedback }}"</em>{% endif %}</div>
                        {% endif %}
                        {% if not booking.driver_rating and not booking.user_rating %}
                          <div class="text-muted"><small>No ratings yet</small></div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- ALL BOOKINGS TAB -->
  <div id="all-bookings" class="user-section">
    <h3>All Bookings</h3>
    <div class="mb-3">
      <form method="POST" action="{{ url_for('admin.clear_orders') }}" onsubmit="return confirm('Are you sure you want to delete ALL orders? This cannot be undone!');">
        <button class="btn btn-danger btn-sm" type="submit">üóëÔ∏è Clear All Orders</button>
      </form>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-modern">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Route</th>
            <th>Status</th>
            <th>Price</th>
            <th>Driver</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Ratings</th>
          </tr>
        </thead>
        <tbody>
          {% for b in bookings %}
            <tr class="status-row status-{{ b.status }}">
              <td><strong>#{{ b.id }}</strong></td>
              <td>{{ b.user.username }}</td>
              <td>{{ b.origin | truncate(20) }} ‚Üí {{ b.destination | truncate(20) }}</td>
              <td><span class="status-badge status-{{ b.status }}">{{ b.status | upper }}</span></td>
              <td><strong>‚Çπ{{ b.price }}</strong></td>
              <td>{% if b.driver %}{{ b.driver.username }}{% else %}<span style="color: #999;">Pending</span>{% endif %}</td>
              <td>{{ b.payment_method | upper }} (by {{ b.payment_by | upper }})</td>
              <td>{{ b.date }}</td>
              <td>
                {% if b.driver_rating or b.user_rating %}
                  {% if b.driver_rating %}
                    <div><small>User‚ÜíDriver: {{ b.driver_rating }}‚≠ê</small></div>
                  {% endif %}
                  {% if b.user_rating %}
                    <div><small>Driver‚ÜíUser: {{ b.user_rating }}‚≠ê</small></div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- PRICING ANALYSIS TAB -->
  <div id="pricing" class="user-section">
    <h3>Pricing Analysis</h3>
    <div class="analysis-grid">
      <div class="analysis-card">
        <h6>Total Bookings</h6>
        <div class="analysis-value">{{ pricing_stats.total_bookings }}</div>
        <div class="analysis-subtext">All time</div>
      </div>
      <div class="analysis-card">
        <h6>Average Price</h6>
        <div class="analysis-value">‚Ç®{{ pricing_stats.avg_price or '‚Äî' }}</div>
        <div class="analysis-subtext">Mean</div>
      </div>
      <div class="analysis-card">
        <h6>Median Price</h6>
        <div class="analysis-value">‚Ç®{{ pricing_stats.median_price or '‚Äî' }}</div>
        <div class="analysis-subtext">Median</div>
      </div>
      <div class="analysis-card">
        <h6>Price Range</h6>
        <div class="analysis-value">
          ‚Ç®{{ pricing_stats.min_price or '‚Äî' }} - ‚Ç®{{ pricing_stats.max_price or '‚Äî' }}
        </div>
        <div class="analysis-subtext">Min to Max</div>
      </div>
      <div class="analysis-card">
        <h6>Average Distance</h6>
        <div class="analysis-value">{{ pricing_stats.avg_distance or '‚Äî' }} km</div>
        <div class="analysis-subtext">Routes with distance</div>
      </div>
      <div class="analysis-card">
        <h6>Avg Price / km</h6>
        <div class="analysis-value">‚Ç®{{ pricing_stats.avg_price_per_km or '‚Äî' }}</div>
        <div class="analysis-subtext">Routes with distance</div>
      </div>
    </div>

    <div class="analysis-panel">
      <h5 class="mb-3">Price Distribution</h5>
      {% set max_bucket = pricing_stats.price_buckets | map(attribute='count') | max %}
      {% for bucket in pricing_stats.price_buckets %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>{{ bucket.label }}</span>
          <span class="text-muted">{{ bucket.count }}</span>
        </div>
        <div class="analysis-bar mb-3">
          <span style="width: {{ (bucket.count / max_bucket * 100) if max_bucket else 0 }}%"></span>
        </div>
      {% endfor %}
    </div>

    <div class="row g-3">
      <div class="col-lg-6">
        <div class="analysis-panel">
          <h5 class="mb-3">Average Price by Traffic</h5>
          {% if pricing_stats.traffic_avg %}
            {% for level, avg in pricing_stats.traffic_avg.items() %}
              <div class="d-flex justify-content-between mb-2">
                <span>{{ level }}</span>
                <span class="fw-bold">‚Ç®{{ avg }}</span>
              </div>
              {% if pricing_stats.traffic_counts.get(level) %}
                <div class="analysis-subtext mb-2">{{ pricing_stats.traffic_counts.get(level) }} trips</div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="text-muted">No traffic data available.</div>
          {% endif %}
        </div>
      </div>
      <div class="col-lg-6">
        <div class="analysis-panel">
          <h5 class="mb-3">Average Price by Time</h5>
          {% if pricing_stats.time_avg %}
            {% for band, avg in pricing_stats.time_avg.items() %}
              <div class="d-flex justify-content-between mb-2">
                <span>{{ band }}</span>
                <span class="fw-bold">‚Ç®{{ avg }}</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">No time data available.</div>
          {% endif %}
        </div>
      </div>
      <div class="col-lg-6">
        <div class="analysis-panel">
          <h5 class="mb-3">Peak vs Off-Peak</h5>
          <div class="d-flex justify-content-between mb-2">
            <span>Peak Hours</span>
            <span class="fw-bold">‚Ç®{{ pricing_stats.peak_avg or '‚Äî' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Off-Peak</span>
            <span class="fw-bold">‚Ç®{{ pricing_stats.offpeak_avg or '‚Äî' }}</span>
          </div>
          <div class="analysis-subtext">Peak premium: {{ pricing_stats.peak_premium if pricing_stats.peak_premium is not none else '‚Äî' }}%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANAGE USERS TAB -->
  <div id="manage" class="user-section">
    <h3>Manage User Roles</h3>
    <form method="POST" action="{{ url_for('admin.admin_set_role') }}">
      <div class="table-responsive">
        <table class="table table-striped table-modern">
          <thead>
            <tr><th>ID</th><th>Username</th><th>Email</th><th>Phone</th><th>Current Role</th><th>Change Role</th></tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td><strong>{{ u.username }}</strong></td>
                <td>{{ u.email }}</td>
                <td>{{ u.phone or '-' }}</td>
                <td><span class="role-badge role-{{ u.role }}">{{ u.role | upper }}</span></td>
                <td>
                  <select class="form-select form-select-sm" name="role_{{ u.id }}">
                    <option value="user" {% if u.role=='user' %}selected{% endif %}>user</option>
                    <option value="driver" {% if u.role=='driver' %}selected{% endif %}>driver</option>
                    <option value="admin" {% if u.role=='admin' %}selected{% endif %}>admin</option>
                  </select>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="mt-3"><button class="btn btn-success" type="submit">‚úì Update Roles</button></div>
    </form>
  </div>

</div>

<script>
function switchTab(tabName) {
  // Hide all sections
  document.querySelectorAll('.user-section').forEach(el => el.classList.remove('active'));
  
  // Show selected section
  document.getElementById(tabName).classList.add('active');
  
  // Update button styles
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}
</script>
{% endblock %}